# å¿…é¡»æœ‰ events å—
events {
    worker_connections 1024;   # æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # -----------------------------
    # Gzip å‹ç¼©ä¼˜åŒ–
    # -----------------------------
    gzip  on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_vary on;

    # -----------------------------
    # æ—¥å¿—é…ç½®
    # -----------------------------
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  logs/access.log  main;
    error_log   logs/error.log  warn;

    # =============================
    # æ–°å¢ AI æœåŠ¡è´Ÿè½½å‡è¡¡
    # =============================
    upstream ai_backend {
        server 127.0.0.1:8081;
        server 127.0.0.1:8082;
        server 127.0.0.1:8083;
        server 127.0.0.1:8084;
        server 127.0.0.1:8085;
    }

    # -----------------------------
    # HTTP é…ç½®ï¼ˆè‡ªåŠ¨è·³è½¬åˆ° HTTPSï¼‰
    # -----------------------------
    server {
        listen 80;
        server_name pyp.ylkj668.com;

        return 301 https://$host$request_uri;
    }

    # -----------------------------
    # HTTPS é…ç½®
    # -----------------------------
    server {
        listen 443 ssl;
        server_name pyp.ylkj668.com;

        ssl_certificate      C:\pyp\ssl\pyp.ylkj668.com_cert.pem;
        ssl_certificate_key  C:\pyp\ssl\202508291410174294_key.key;

        ssl_protocols        TLSv1.2 TLSv1.3;
        ssl_ciphers          HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
		
		
		# ğŸ”‘ ä¸Šä¼ å¤§å°é™åˆ¶ï¼ˆè¿™é‡Œè®¾ç½®ä¸º 200MBï¼‰
		client_max_body_size 200m;

        # -----------------------------
        # å‰ç«¯é™æ€é¡µé¢
        # -----------------------------
        location / {
            root   C:/pyp/dist;
            index  index.html index.htm;
            try_files $uri /index.html;
        }
		
		
		# ç›®æ ‡æµå¼åœ°å€ï¼š/jeecg-boot/pengyipeng/api/ai/stream
		location /jeecg-boot/pengyipeng/api/ai/stream {
			# 1. ä¸Šæ¸¸æœåŠ¡åœ°å€ï¼ˆJeecg-Boot åç«¯çš„çœŸå®åœ°å€ï¼Œå¦‚ Tomcat/Jetty åœ°å€ï¼‰
			# æ ¼å¼ï¼šhttp://[ä¸Šæ¸¸IP]:[ä¸Šæ¸¸ç«¯å£]ï¼Œè‹¥åç«¯æ˜¯é›†ç¾¤å¯é…ç½® proxy_pass http://backend_cluster;
			proxy_pass http://127.0.0.1:8080/jeecg-boot/pengyipeng/api/ai/stream;  # ç¤ºä¾‹ï¼šæœ¬åœ° Jeecg-Boot ç«¯å£ 8080

			# 2. æµå¼å…³é”®å‚æ•°ï¼ˆè¦†ç›–å…¨å±€æˆ–è¡¥å……ï¼‰
			proxy_buffering off;              # å¼ºåˆ¶ç¦ç”¨ç¼“å†²ï¼ˆæ ¸å¿ƒï¼‰
			proxy_max_temp_file_size 0;       # ç¦ç”¨ä¸´æ—¶æ–‡ä»¶
			proxy_read_timeout 600s;          # é•¿è¿æ¥è¶…æ—¶ï¼ˆAI æµå¯èƒ½æŒç»­å‡ åˆ†é’Ÿï¼‰
			proxy_http_version 1.1;           # å¯ç”¨ HTTP/1.1ï¼ˆæ”¯æŒ Chunked ç¼–ç å’Œé•¿è¿æ¥ï¼‰
			proxy_set_header Connection "";   # æ¸…é™¤ Connection å¤´ï¼Œé¿å…ä¸Šæ¸¸å…³é—­é•¿è¿æ¥

			# 3. é€‚é… SSEï¼ˆServer-Sent Eventsï¼‰åœºæ™¯ï¼ˆè‹¥ä½ çš„æµæ˜¯ SSEï¼Œå¿…é¡»åŠ æ­¤é…ç½®ï¼‰
			proxy_set_header Accept-Encoding "";  # ç¦ç”¨ç¼–ç å‹ç¼©
			add_header Cache-Control "no-cache";  # å‘ŠçŸ¥å®¢æˆ·ç«¯ä¸ç¼“å­˜ SSE æµ
			add_header X-Accel-Buffering "no";    # ç¦ç”¨ Nginx åŠ é€Ÿç¼“å†²ï¼ˆSSE å…³é”®ï¼‰

			# 4. é€‚é… WebSocket åœºæ™¯ï¼ˆè‹¥ä½ çš„æµæ˜¯ WebSocketï¼Œéœ€è¡¥å……ä»¥ä¸‹ 3 è¡Œï¼‰
			# proxy_set_header Upgrade $http_upgrade;
			# proxy_set_header Connection "upgrade";
			# proxy_read_timeout 3600s;  # WebSocket è¶…æ—¶å¯è®¾æ›´é•¿ï¼ˆå¦‚ 1 å°æ—¶ï¼‰
		}
		
		
		# -----------------------------
		# ç”¨æˆ·ç«¯ H5 é¡µé¢
		# -----------------------------
		location /h5/ {
			root   C:/pyp;
			index  index.html index.htm;
			try_files $uri /h5/index.html;
		}

        # -----------------------------
        # AI æœåŠ¡åå‘ä»£ç†ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
        # -----------------------------
        location /jeecg-boot/pengyipeng/user-app/api/ai/generate {
            proxy_pass http://ai_backend/pengyipeng/user-app/api/ai/generate;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 60s;
            proxy_read_timeout 300s;
        }

        # -----------------------------
        # MINIO æ–‡ä»¶æœåŠ¡åå‘ä»£ç†
        # -----------------------------
        location /minio/ {
            proxy_pass http://127.0.0.1:9000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 60s;
            proxy_read_timeout 60s;
        }

        # -----------------------------
        # Jeecg-Boot åå°æ¥å£åå‘ä»£ç†
        # -----------------------------
        location /jeecg-boot/ {
            proxy_pass         http://127.0.0.1:8080/jeecg-boot/;
            proxy_redirect off;
            proxy_set_header  Host             $host;
            proxy_set_header  X-Real-IP        $remote_addr;
            set $my_proxy_add_x_forwarded_for $proxy_add_x_forwarded_for;
            if ($proxy_add_x_forwarded_for ~* "127.0.0.1"){
                set $my_proxy_add_x_forwarded_for $remote_addr;
            }
            proxy_set_header   X-Forwarded-For $my_proxy_add_x_forwarded_for;
        }

        location /jeecgboot/ {
            proxy_pass         http://127.0.0.1:8080/jeecg-boot/;
            proxy_redirect off;
            proxy_set_header  Host             $host;
            proxy_set_header  X-Real-IP        $remote_addr;
            set $my_proxy_add_x_forwarded_for $proxy_add_x_forwarded_for;
            if ($proxy_add_x_forwarded_for ~* "127.0.0.1"){
                set $my_proxy_add_x_forwarded_for $remote_addr;
            }
            proxy_set_header   X-Forwarded-For $my_proxy_add_x_forwarded_for;
        }

        # -----------------------------
        # é”™è¯¯é¡µé¢é…ç½®
        # -----------------------------
        error_page  500 502 503 504  /50x.html;
        location = /50x.html {
            root html;
        }
    }

}
